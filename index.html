<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Infinix & Yango Christmas</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Efeitos -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Fonte Premium -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --xmas-red: #D42426;
            --xmas-green: #0A5C36;
            --xmas-gold: #FFD700;
            --snow-white: #FFFFFF;
            --neon-green: #00ea77; 
            --neon-red: #ff3b30;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Montserrat', sans-serif;
            background-color: var(--xmas-red);
            background-image: url('1background-min.png'); 
            background-size: cover; background-position: center;
            background-repeat: no-repeat; background-attachment: fixed;
            margin: 0; padding: 0; height: 100vh;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; position: relative;
        }
        
        body::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.3); z-index: 0; pointer-events: none;
        }

        /* ANIMA√á√ÉO DE NEVE */
        .snowflake {
            position: absolute; top: -10px; z-index: 1; color: #fff; opacity: 0.8;
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
            animation: fall linear infinite; font-size: 1.2em; pointer-events: none;
        }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

        /* CONTENT CARD */
        .arcade-container {
            width: 90%; max-width: 400px;
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: 40px; padding: 30px 20px;
            box-shadow: 0 30px 60px -10px rgba(0, 0, 0, 0.5);
            text-align: center; position: relative; z-index: 10;
            display: none; flex-direction: column; max-height: 95vh;
            border: 4px solid var(--xmas-gold);
        }

        .logos-area { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px; }
        .logo-img { height: 35px; width: auto; object-fit: contain; }
        .x-divider { color: var(--xmas-red); font-size: 24px; font-weight: 900; }

        h1 { margin: 0 0 10px 0; font-size: 26px; font-weight: 900; color: var(--xmas-red); text-transform: uppercase; }
        p { color: #555; font-size: 14px; margin: 0 0 20px 0; font-weight: 500; }

        .game-input {
            width: 100%; padding: 16px 20px; background: #F3F4F6;
            border: 2px solid #E5E7EB; border-radius: 16px;
            color: #1F2937; font-family: 'Montserrat', sans-serif; font-size: 16px; font-weight: 600;
            text-align: center; outline: none; margin-bottom: 12px;
        }
        .game-input:focus { border-color: var(--xmas-green); background: #fff; }

        .btn-play {
            width: 100%; padding: 18px;
            background: linear-gradient(180deg, #E63946 0%, #B91C1C 100%);
            border: none; border-radius: 16px;
            color: white; font-weight: 900; font-size: 18px; text-transform: uppercase;
            cursor: pointer; margin-top: 15px;
            box-shadow: 0 6px 0 #8B1212, 0 15px 20px rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-play:active { transform: translateY(4px); box-shadow: 0 2px 0 #8B1212; }
        .btn-play:disabled { filter: grayscale(1); opacity: 0.7; transform: none; box-shadow: none; }

        #stock-panel { margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 6px; display: none; }
        .stock-badge { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 5px; font-size: 10px; font-weight: 600; color: #555; }
        .stock-badge b { color: var(--xmas-green); }

        /* RODA */
        .wheel-wrapper {
            position: relative; width: 300px; height: 300px; margin: 10px auto 25px;
            display: flex; align-items: center; justify-content: center;
        }
        .wheel-outer-rim {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            background: #fff; border: 10px solid var(--xmas-gold); box-sizing: border-box; z-index: 0;
        }
        .wheel-dots { position: absolute; width: 100%; height: 100%; border-radius: 50%; z-index: 1; }
        .dot { position: absolute; width: 8px; height: 8px; background: #fff; border-radius: 50%; box-shadow: 0 0 5px #FFD700; left: 50%; top: 5px; transform-origin: 0 145px; }

        canvas#wheel { position: relative; z-index: 2; width: 280px; height: 280px; border-radius: 50%; transform-origin: center center; will-change: transform; }
        .pointer { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); z-index: 20; width: 40px; height: 50px; background: var(--xmas-red); clip-path: polygon(50% 100%, 0 0, 100% 0); filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        .wheel-center-logo { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 55px; height: 55px; background: #fff; border-radius: 50%; z-index: 3; display: flex; align-items: center; justify-content: center; border: 4px solid var(--xmas-gold); color: var(--xmas-red); font-weight: 900; font-size: 13px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* ALERT BOX */
        #msgBox { margin-top: 20px; padding: 15px; border-radius: 16px; font-size: 14px; font-weight: 700; display: none; }
        .success { color: #155724; background: #d4edda; border: 1px solid #c3e6cb; }
        .error { color: #721c24; background: #f8d7da; border: 1px solid #f5c6cb; }

        #access-denied { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url('1background-min.png'); background-size: cover; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px; }
        .denied-box { background: rgba(255,255,255,0.95); padding: 40px; border-radius: 30px; border: 4px solid var(--xmas-gold); }
    </style>
</head>
<body>

<div id="snow-container"></div>

<div id="access-denied">
    <div class="denied-box">
        <h2 style="color:var(--xmas-red); margin:0 0 10px 0;">Acesso Exclusivo üéÑ</h2>
        <p style="color:#555;">Esta campanha √© exclusiva para passageiros Yango.</p>
        <p style="font-size:12px; color:#888;">Digitaliza o QR Code no carro para entrar.</p>
    </div>
</div>

<div class="arcade-container" id="main-app">
    <div class="logos-area">
        <img src="logo-min.png" alt="Infinix" class="logo-img">
        <span class="x-divider">√ó</span>
        <img src="logo yango-min.png" alt="Yango" class="logo-img">
    </div>

    <div id="step-login">
        <h1>Natal Premiado</h1>
        <p>Preenche os teus dados para girar a roda!</p>
        <input type="text" id="inputName" class="game-input" placeholder="O teu Nome">
        <input type="email" id="inputEmail" class="game-input" placeholder="O teu Email">
        <input type="tel" id="inputPhone" class="game-input" placeholder="Telem√≥vel (84/85...)">
        <button onclick="enterGame()" id="btnSend" class="btn-play">ENTRAR</button>
    </div>

    <div id="step-wheel">
        <h1>Boa Sorte! <span id="admin-badge" class="badge bg-admin" style="display:none; background:var(--xmas-gold); color:#fff; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:5px;">ADMIN</span></h1>
        
        <div id="stock-panel">
            <div class="stock-badge" id="s_mzn500">üíµ 500: <b>..</b></div>
            <div class="stock-badge" id="s_mzn1000">üíµ 1000: <b>..</b></div>
            <div class="stock-badge" id="s_mzn2000">üíµ 2000: <b>..</b></div>
            <div class="stock-badge" id="s_powerbank">üîã Power: <b>..</b></div>
            <div class="stock-badge" id="s_smartwatch">‚åö Watch: <b>..</b></div>
            <div class="stock-badge" id="s_buds">üéß Buds: <b>..</b></div>
        </div>

        <div class="wheel-wrapper">
            <div class="wheel-outer-rim"><div id="wheel-dots-container" class="wheel-dots"></div></div>
            <div class="pointer"></div>
            <canvas id="wheel"></canvas>
            <div class="wheel-center-logo">WIN</div>
        </div>

        <button onclick="spinWheel()" id="btnSpin" class="btn-play">GIRAR üéÅ</button>
    </div>
    <div id="msgBox"></div>
</div>

<script>
    // Configura√ß√µes
    const SHEET_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbxdt--iC4oRJdde0SUahq17Pi5gdxWv6ctqv-7ricHgZC9IjjdZstXTPQ86CcWRu0IW/exec";
    const firebaseConfig = {
        apiKey: "AIzaSyDbvibPXx9rc8nyA4CKQNE5xAPevw4PnrE", 
        authDomain: "spin-the-wheel0.firebaseapp.com",
        projectId: "spin-the-wheel0",
        storageBucket: "spin-the-wheel0.firebasestorage.app",
        messagingSenderId: "490612802646",
        appId: "1:490612802646:web:043a7f993206f0d745a7f7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const canvas = document.querySelector("#wheel");
    const ctx = canvas.getContext("2d");
    const size = 280;
    const dpr = window.devicePixelRatio || 1;
    canvas.width = size * dpr; canvas.height = size * dpr;
    canvas.style.width = `${size}px`; canvas.style.height = `${size}px`;
    ctx.scale(dpr, dpr);
    const rad = size / 2;

    // Criar luzes na borda da roda
    const dotsContainer = document.getElementById('wheel-dots-container');
    for(let i=0; i<12; i++) {
        const dot = document.createElement('div');
        dot.className = 'dot'; dot.style.transform = `rotate(${i * 30}deg)`;
        dotsContainer.appendChild(dot);
    }

    const sectors = [
        { label: "mzn500", text: "500 MT", color: "#C31515", textCol: "#fff", img: "500MZN.jpg" },
        { label: "mzn1000", text: "1000 MT", color: "#F1FAEE", textCol: "#C31515", img: "1000MZN.jpg" },
        { label: "mzn2000", text: "2000 MT", color: "#2F5D48", textCol: "#fff", img: "1000MZN.jpg", isDouble: true },
        { label: "powerbank", text: "PowerBank", color: "#C31515", textCol: "#fff", img: "powerbank.jpg" },
        { label: "smartwatch", text: "SmartWatch", color: "#F1FAEE", textCol: "#2F5D48", img: "watch.png" },
        { label: "buds", text: "Buds", color: "#2F5D48", textCol: "#fff", img: "buds.png" }
    ];

    const arc = (2 * Math.PI) / sectors.length;
    let currentRotation = 0;
    let isAdmin = false;
    let userData = {};
    let currentStock = {};

    // Carregamento de imagens para a roda
    const loadedImages = {};
    sectors.forEach(s => {
        const img = new Image(); img.src = s.img;
        img.onload = () => { loadedImages[s.label] = img; drawWheel(); };
    });

    function drawWheel() {
        ctx.clearRect(0, 0, size, size);
        sectors.forEach((s, i) => {
            const ang = arc * i;
            ctx.save(); ctx.beginPath(); ctx.fillStyle = s.color;
            ctx.moveTo(rad, rad); ctx.arc(rad, rad, rad, ang, ang + arc); ctx.fill();
            ctx.strokeStyle = "#FFD700"; ctx.lineWidth = 2; ctx.stroke();
            ctx.translate(rad, rad); ctx.rotate(ang + arc / 2);
            if (loadedImages[s.label]) {
                ctx.save(); ctx.rotate(Math.PI);
                const iW = 45, iH = 45;
                if(s.isDouble) { 
                    ctx.drawImage(loadedImages[s.label], -rad + 45, -20, iW, iH); 
                    ctx.drawImage(loadedImages[s.label], -rad + 35, -10, iW, iH); 
                } else { 
                    ctx.drawImage(loadedImages[s.label], -rad + 40, -iH/2, iW, iH); 
                }
                ctx.restore();
                ctx.textAlign = "right"; ctx.fillStyle = s.textCol; ctx.font = "bold 12px Montserrat";
                ctx.fillText(s.text, rad - 55, 4);
            } else {
                ctx.textAlign = "right"; ctx.fillStyle = s.textCol; ctx.font = "bold 14px Montserrat";
                ctx.fillText(s.text, rad - 30, 5);
            }
            ctx.restore();
        });
    }

    function checkAccess() {
        const id = new URLSearchParams(window.location.search).get('id');
        if (id && ['carro_01', 'carro_02', 'carro_03'].includes(id.toLowerCase())) {
            userData.car_id = id;
            document.getElementById('access-denied').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            return true;
        }
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('access-denied').style.display = 'flex';
        return false;
    }

    async function enterGame() {
        const name = document.getElementById('inputName').value;
        const email = document.getElementById('inputEmail').value;
        let phone = document.getElementById('inputPhone').value.trim();
        if(!name || !email || !phone) return alert("Por favor, preencha todos os dados.");
        
        let digits = phone.replace(/\D/g, '');
        if (digits.startsWith('258')) digits = digits.substring(3);
        if (digits.length !== 9) return alert("N√∫mero de contacto inv√°lido.");
        
        const finalPhone = "+258" + digits;
        userData = { ...userData, name, email, phone: finalPhone };

        if(btoa(finalPhone) === "KzI1ODg2NTQ3NjMzMw==") {
            isAdmin = true;
            document.getElementById('admin-badge').style.display = 'inline-block';
            document.getElementById('stock-panel').style.display = 'grid';
        }

        document.getElementById('step-login').style.display = 'none';
        document.getElementById('step-wheel').style.display = 'block';
        listenStock();
    }

    function listenStock() {
        db.collection("config").doc("inventory").onSnapshot(doc => {
            if(doc.exists) {
                currentStock = doc.data();
                Object.keys(currentStock).forEach(k => {
                    const el = document.getElementById(`s_${k}`);
                    if(el) el.querySelector('b').innerText = currentStock[k];
                });
            }
        });
    }

    function spinWheel() {
        const btn = document.getElementById('btnSpin');
        btn.disabled = true; btn.innerText = "A GIRAR...";
        document.getElementById('msgBox').style.display = 'none';

        // L√≥gica de sorteio aleat√≥rio
        const r = Math.random() * 100;
        let key = "";
        if (r < 31) key = "mzn500";
        else if (r < 51) key = "mzn1000";
        else if (r < 69) key = "mzn2000";
        else if (r < 79) key = "powerbank";
        else if (r < 89) key = "smartwatch";
        else key = "buds";

        const index = sectors.findIndex(s => s.label === key);
        const targetRot = 360 * 5 + (270 - (index * (360/sectors.length)) - (360/sectors.length/2));
        
        const dist = targetRot - (currentRotation % 360);
        currentRotation += (dist < 0 ? dist + 360 : dist);

        canvas.style.transition = "transform 4s cubic-bezier(0.2, 0.8, 0.2, 1)";
        canvas.style.transform = `rotate(${currentRotation}deg)`;

        setTimeout(() => endSpin(key, sectors[index].text), 4000);
    }

    async function endSpin(key, label) {
        // VERIFICA√á√ÉO DE STOCK AO PARAR
        if (currentStock[key] <= 0 && !isAdmin) {
            showMsg(`Este pr√©mio esgotou! üéÅ Tenta a tua sorte na pr√≥xima viagem.`, "error");
            btnReset();
            return;
        }

        // SE HOUVER STOCK, PROCESSA A VIT√ìRIA
        if(!isAdmin) {
            try {
                const batch = db.batch();
                const invRef = db.collection("config").doc("inventory");
                const winRef = db.collection("winners").doc();
                
                // S√≥ abate se for maior que zero (Prote√ß√£o de -2)
                batch.update(invRef, { [key]: firebase.firestore.FieldValue.increment(-1) });
                batch.set(winRef, { ...userData, prize: label, win_at: new Date() });
                await batch.commit();

                // Webhook para Google Sheets
                fetch(SHEET_WEBHOOK_URL, { method:'POST', mode:'no-cors', body:JSON.stringify({ ...userData, prize: label }) });
            } catch (e) {
                console.error("Erro ao gravar:", e);
            }
        }

        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        showMsg(`PARAB√âNS! Ganhaste: ${label}! üéâ`, "success");
        btnReset();
    }

    function btnReset() {
        setTimeout(() => {
            const btn = document.getElementById('btnSpin');
            btn.disabled = false;
            btn.innerText = "GIRAR NOVAMENTE";
        }, 2000);
    }

    function showMsg(txt, type) {
        const box = document.getElementById('msgBox');
        box.style.display = 'block'; box.innerText = txt; box.className = type;
    }

    window.onload = checkAccess;

    function createSnow() {
        const container = document.getElementById('snow-container');
        for(let i=0; i<30; i++) {
            const s = document.createElement('div');
            s.className = 'snowflake'; s.innerHTML = '‚ùÑ';
            s.style.left = Math.random() * 100 + 'vw';
            s.style.animationDuration = Math.random() * 3 + 2 + 's';
            container.appendChild(s);
        }
    }
    createSnow();
</script>

</body>
</html>
