<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Infinix & Yango Arcade</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #130b21;
            --card-bg: #1e1333;
            --neon-pink: #ff0055;
            --neon-green: #00ff9d;
            --neon-blue: #00d9ff;
            --neon-yellow: #ffcc00;
            --text-white: #ffffff;
        }

        body { 
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 0, 85, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 255, 157, 0.15) 0%, transparent 40%);
            color: var(--text-white);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }

        /* CARD PRINCIPAL */
        .arcade-container {
            width: 100%; max-width: 360px;
            background: rgba(30, 19, 51, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 30px 20px;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.1), 0 20px 50px rgba(0,0,0,0.6);
            text-align: center;
            position: relative;
            display: flex; flex-direction: column;
            max-height: 90vh;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* TELA DE ACESSO NEGADO */
        #access-denied {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-deep); z-index: 9999;
            display: none; /* Escondido por defeito */
            flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 40px; box-sizing: border-box;
        }
        #access-denied h2 { color: var(--neon-pink); font-size: 24px; margin-bottom: 10px; text-transform: uppercase; }
        #access-denied p { color: #ccc; font-size: 16px; line-height: 1.6; }
        .lock-icon { font-size: 60px; margin-bottom: 20px; }

        .lights-bar {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .light-group { display: flex; gap: 8px; }
        .light { width: 8px; height: 8px; border-radius: 50%; background: #333; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .light.on-pink { background: var(--neon-pink); box-shadow: 0 0 10px var(--neon-pink); }
        .light.on-green { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
        
        .sound-toggle { font-size: 16px; cursor: pointer; opacity: 0.7; }

        h1 { margin: 0; font-size: 22px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        p { color: #aaa; font-size: 13px; margin-top: 5px; margin-bottom: 25px; }

        .game-input {
            width: 100%; padding: 15px;
            background: #130b21;
            border: 2px solid #2d1f45;
            border-radius: 12px;
            color: #fff; font-family: 'Outfit', sans-serif; font-size: 16px;
            text-align: center; outline: none; margin-bottom: 12px;
            box-sizing: border-box; transition: 0.3s;
        }
        .game-input:focus { border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(0, 217, 255, 0.3); }

        .btn-play {
            width: 100%; padding: 16px;
            background: linear-gradient(90deg, var(--neon-pink), #ff5e00);
            border: none; border-radius: 12px;
            color: white; font-weight: 800; font-size: 16px; text-transform: uppercase;
            cursor: pointer; margin-top: 15px;
            box-shadow: 0 5px 20px rgba(255, 0, 85, 0.4);
            position: relative; overflow: hidden;
            transition: transform 0.1s;
        }
        .btn-play:active { transform: scale(0.97); }
        .btn-play:disabled { filter: grayscale(1); cursor: not-allowed; }

        .btn-export {
            background: transparent; border: 1px solid var(--neon-green); color: var(--neon-green);
            padding: 8px 15px; border-radius: 8px; font-size: 12px; font-weight: 700;
            cursor: pointer; margin-top: 10px; display: none; width: 100%; text-transform: uppercase;
        }
        .btn-export:hover { background: rgba(0, 255, 157, 0.1); }

        .wheel-wrapper {
            position: relative; width: 280px; height: 280px; margin: 10px auto;
            display: flex; align-items: center; justify-content: center;
        }
        
        .wheel-background {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            background: #130b21; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 6px solid #2d1f45; box-sizing: border-box; z-index: 0;
        }

        canvas#wheel {
            position: relative; z-index: 1; width: 260px; height: 260px;
            border-radius: 50%; transform-origin: center center;
        }

        .pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            z-index: 10; width: 0; height: 0;
            border-left: 18px solid transparent; border-right: 18px solid transparent;
            border-top: 35px solid var(--neon-pink);
            filter: drop-shadow(0 4px 5px rgba(0,0,0,0.5));
        }

        .floating-icon { animation: float 3s ease-in-out infinite; display: inline-block; margin-bottom: 10px; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        #msgBox { margin-top: 15px; padding: 12px; border-radius: 8px; font-size: 13px; font-weight: 700; display: none; }
        .success { color: var(--neon-green); background: rgba(0, 255, 157, 0.1); border: 1px solid var(--neon-green); }
        .error { color: var(--neon-pink); background: rgba(255, 0, 85, 0.1); border: 1px solid var(--neon-pink); }

        .legal-footer { margin-top: 20px; font-size: 10px; color: #666; }
        .legal-footer a { color: #888; text-decoration: none; margin: 0 5px; }
        
        #terms-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100; display: none;
            align-items: center; justify-content: center;
        }
        .terms-box { background: var(--card-bg); padding: 25px; border-radius: 20px; width: 85%; max-width: 300px; text-align: left; border: 1px solid #333; }
        .terms-box h3 { color: var(--neon-green); margin-top: 0; }
        .terms-box p { color: #ccc; font-size: 12px; }

        #step-otp, #step-wheel { display: none; }
        .badge { font-size: 9px; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; font-weight: 800; display: inline-block; margin-left: 5px; }
        .bg-test { background: var(--neon-yellow); color: black; }
        .bg-admin { background: var(--neon-green); color: black; }
    </style>
</head>
<body>

<!-- TELA DE ACESSO NEGADO -->
<div id="access-denied">
    <div class="lock-icon">ðŸ”’</div>
    <h2>Acesso Exclusivo</h2>
    <p>Esta oferta Ã© exclusiva para passageiros Yango.</p>
    <p style="font-size:14px; margin-top:20px; color:var(--neon-blue)">Encontra um carro Yango e digitaliza o cÃ³digo para participar!</p>
</div>

<div id="terms-modal">
    <div class="terms-box">
        <h3>Regras Oficiais</h3>
        <p>1. Limite de 1 tentativa diÃ¡ria por nÃºmero.</p>
        <p>2. O sistema deteta e bloqueia bots.</p>
        <p>3. PrÃ©mios fÃ­sicos levantam-se na loja Infinix.</p>
        <button onclick="document.getElementById('terms-modal').style.display='none'" class="btn-play" style="margin-top:15px; padding:10px;">FECHAR</button>
    </div>
</div>

<div class="arcade-container" id="main-app">
    <div class="lights-bar">
        <div class="light-group">
            <div class="light on-pink"></div>
            <div class="light"></div>
            <div class="light on-green"></div>
        </div>
        <div class="sound-toggle" onclick="toggleSound()" id="sound-btn">ðŸ”Š</div>
    </div>

    <!-- TELA 1: LOGIN -->
    <div id="step-login">
        <div class="floating-icon">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#00d9ff" stroke-width="1.5"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><path d="M12 6v6l4 2"/></svg>
        </div>
        <h1>Arcade Login</h1>
        <p>Entra para a zona de prÃ©mios.</p>

        <input type="text" id="inputName" class="game-input" placeholder="Teu Nome">
        <input type="email" id="inputEmail" class="game-input" placeholder="Teu Email">
        <input type="tel" id="inputPhone" class="game-input" placeholder="+258 84 ...">
        <div id="recaptcha-container" style="display:flex; justify-content:center; margin:10px 0;"></div>
        
        <button onclick="enviarSMS()" id="btnSend" class="btn-play">START GAME</button>
    </div>

    <!-- TELA 2: OTP -->
    <div id="step-otp">
        <h1>SeguranÃ§a</h1>
        <p>CÃ³digo SMS enviado para <b id="lblPhone">...</b></p>
        
        <div style="font-size:10px; color:#666; margin-bottom:10px;">(Test Code: 123456)</div>
        <input type="number" id="inputCode" class="game-input" placeholder="000 000" style="font-size: 24px; letter-spacing: 5px; font-weight:800;">
        
        <button onclick="validarOTP()" class="btn-play">UNLOCK</button>
        <button onclick="location.reload()" style="background:none; border:none; color:#666; margin-top:10px; cursor:pointer;">Cancelar</button>
    </div>

    <!-- TELA 3: RODA -->
    <div id="step-wheel">
        <h1>Spin & Win <span id="admin-badge" class="badge bg-admin" style="display:none">ADMIN</span></h1>
        <p>Boa sorte, <span id="lblName" style="color:var(--neon-green)"></span>!</p>

        <div class="wheel-wrapper">
            <div class="wheel-background"></div>
            <div class="pointer"></div>
            <canvas id="wheel" width="260" height="260"></canvas>
        </div>

        <button id="btnSpin" class="btn-play">GIRAR (FREE)</button>
        <button id="btnExport" class="btn-export" onclick="exportData()">ðŸ“¥ Exportar Dados (Excel)</button>
        
        <div class="legal-footer">
            <a href="#" onclick="document.getElementById('terms-modal').style.display='flex'">Termos</a> | <a href="#">Privacidade</a>
        </div>
    </div>

    <div id="msgBox"></div>
</div>

<script>
    // --- 1. VERIFICAÃ‡ÃƒO DE SEGURANÃ‡A (QR CODE) ---
    // O cÃ³digo verifica se o URL tem "?access=yango_car"
    // Se nÃ£o tiver, bloqueia o acesso (exceto se for admin a fazer login)
    function checkAccess() {
        const urlParams = new URLSearchParams(window.location.search);
        const accessCode = urlParams.get('access');
        
        if (accessCode !== 'yango_car') {
            // Esconder app e mostrar aviso
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('access-denied').style.display = 'flex';
            return false;
        }
        return true;
    }
    
    // Executar verificaÃ§Ã£o ao iniciar
    const hasValidLink = checkAccess();

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    let soundOn = true;

    function toggleSound() {
        soundOn = !soundOn;
        document.getElementById('sound-btn').innerText = soundOn ? 'ðŸ”Š' : 'ðŸ”‡';
    }

    function playTone(freq, type, dur) {
        if (!soundOn) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + dur);
    }

    const sfx = {
        click: () => playTone(600, 'square', 0.1),
        tick: () => playTone(800, 'triangle', 0.05),
        win: () => { [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => playTone(f, 'sine', 0.4), i*150)); },
        error: () => playTone(150, 'sawtooth', 0.4)
    };

const firebaseConfig = {

  apiKey: "AIzaSyDbvibPXx9rc8nyA4CKQNE5xAPevw4PnrE",

  authDomain: "spin-the-wheel0.firebaseapp.com",

  projectId: "spin-the-wheel0",

  storageBucket: "spin-the-wheel0.firebasestorage.app",

  messagingSenderId: "490612802646",

  appId: "1:490612802646:web:043a7f993206f0d745a7f7",

  measurementId: "G-GSYX6N4BXB"

};


    // Admin Phone (Base64 Encoded: +258865476333)
    const ADMIN_B64 = "KzI1ODg2NTQ3NjMzMw=="; 

    const sectors = [
        { color: "#00d9ff", text: "10%", label: "Desconto Yango", textCol: "#000" }, 
        { color: "#8a2be2", text: "AIOT", label: "AcessÃ³rios", textCol: "#fff" },    
        { color: "#221638", text: "TENTE", label: "Tente de Novo", textCol: "#aaa" }, 
        { color: "#ffcc00", text: "HOT 60", label: "HOT 60 Pro+", textCol: "#000" },  
        { color: "#ff0055", text: "20%", label: "Desconto Yango", textCol: "#fff" },  
        { color: "#00ff9d", text: "AIOT", label: "AcessÃ³rios", textCol: "#000" }      
    ];

    const canvas = document.querySelector("#wheel");
    const ctx = canvas.getContext("2d");
    const dia = canvas.width; 
    const rad = dia / 2;
    const PI = Math.PI;
    const TAU = 2 * PI;
    const arc = TAU / sectors.length;
    let currentRotation = 0;

    function drawWheel() {
        ctx.clearRect(0, 0, dia, dia);
        sectors.forEach((sector, i) => {
            const angulo = arc * i;
            ctx.save();
            ctx.beginPath();
            ctx.fillStyle = sector.color;
            ctx.moveTo(rad, rad);
            ctx.arc(rad, rad, rad, angulo, angulo + arc);
            ctx.lineTo(rad, rad);
            ctx.fill();
            
            ctx.strokeStyle = "#130b21";
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.translate(rad, rad);
            ctx.rotate(angulo + arc / 2);
            ctx.textAlign = "right";
            ctx.fillStyle = sector.textCol;
            ctx.font = "800 14px Outfit"; 
            ctx.fillText(sector.text, rad - 25, 5);
            ctx.restore();
        });
        
        ctx.beginPath();
        ctx.arc(rad, rad, 30, 0, TAU);
        ctx.fillStyle = "#1e1333";
        ctx.fill();
        ctx.strokeStyle = "#00d9ff";
        ctx.lineWidth = 3;
        ctx.stroke();
    }
    drawWheel();

    let isOffline = false;
    let isAdmin = false;
    let confirmationResult = null;
    let userData = {};

    try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch(e) { ativarModoOffline(); }
    const auth = firebase.auth();
    const db = firebase.firestore();

    window.onload = () => {
        auth.languageCode = 'pt';
        try {
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'normal', theme: 'dark' });
            window.recaptchaVerifier.render();
        } catch(e) { ativarModoOffline(); }
        
        document.body.addEventListener('click', () => { if(audioCtx.state === 'suspended') audioCtx.resume(); }, {once:true});
    };

    function ativarModoOffline() {
        if(isOffline) return; isOffline = true;
        document.getElementById('recaptcha-container').style.display = 'none';
        // Se estiver offline, mostra a app mesmo sem link correto para permitir teste
        document.getElementById('main-app').style.display = 'flex';
        document.getElementById('access-denied').style.display = 'none';
    }

    window.enviarSMS = () => {
        sfx.click();
        const name = document.getElementById('inputName').value;
        const email = document.getElementById('inputEmail').value;
        const phone = document.getElementById('inputPhone').value.trim();
        
        if(!name || !email || !phone) return showMsg("Preencha todos os dados", "error");
        userData = { name, email, phone };

        // Verifica Admin
        const cleanPhone = phone.replace(/\s/g, '');
        if(btoa(cleanPhone) === ADMIN_B64) {
            isAdmin = true; 
            document.getElementById('admin-badge').style.display = 'inline-block';
            document.getElementById('btnExport').style.display = 'block';
            // Admin desbloqueia a app mesmo se o link estiver errado
            document.getElementById('main-app').style.display = 'flex';
            document.getElementById('access-denied').style.display = 'none';
        }

        const btn = document.getElementById('btnSend');
        btn.disabled = true; btn.innerText = "A carregar...";
        
        if(isOffline) { setTimeout(irParaOTP, 800); return; }

        firebase.auth().signInWithPhoneNumber(phone, window.recaptchaVerifier)
            .then((res) => { confirmationResult = res; irParaOTP(); })
            .catch(() => { ativarModoOffline(); irParaOTP(); });
    };

    function irParaOTP() {
        document.getElementById('step-login').style.display = 'none';
        document.getElementById('step-otp').style.display = 'block';
        document.getElementById('lblPhone').innerText = userData.phone;
    }

    window.validarOTP = () => {
        sfx.click();
        const code = document.getElementById('inputCode').value;
        if(isOffline) {
            if(code === "123456") checkElegibilidade("off_" + userData.phone);
            else showMsg("CÃ³digo errado", "error");
            return;
        }
        confirmationResult.confirm(code).then((res) => checkElegibilidade(res.user.uid))
            .catch(() => showMsg("Erro cÃ³digo", "error"));
    };

    function checkElegibilidade(uid) {
        if(isAdmin) { liberar(); return; }
        
        // VerificaÃ§Ã£o final do link (apenas para utilizadores normais)
        if (!hasValidLink) {
            // Se chegou aqui (hackeando o UI) mas nÃ£o tem link, bloqueia
            alert("Acesso Negado: Link InvÃ¡lido.");
            location.reload();
            return;
        }

        const today = new Date().toISOString().split('T')[0];
        if(localStorage.getItem("spin_" + userData.phone) === today) { bloquear(); return; }
        if(isOffline) { liberar(); return; }

        db.collection("participants").doc(uid).get().then((doc) => {
            if(doc.exists && doc.data().last_spin_date === today) bloquear(); else liberar();
        }).catch(() => liberar());
    }

    function bloquear() {
        sfx.error();
        document.getElementById('step-otp').style.display = 'none';
        showMsg("JÃ¡ jogaste hoje! Volta amanhÃ£.", "error");
    }

    function liberar() {
        document.getElementById('step-otp').style.display = 'none';
        document.getElementById('step-wheel').style.display = 'block';
        document.getElementById('lblName').innerText = userData.name.split(" ")[0];
    }

    async function exportData() {
        if(!isAdmin) return;
        const btn = document.getElementById('btnExport');
        btn.innerText = "A Gerar Excel...";
        
        try {
            let data = [];
            if(isOffline) {
                data = [{Nome: "Teste", Email: "teste@email.com", Telefone: "+25884000", Premio: "AIOT", Data: "2023-10-27"}];
            } else {
                const snapshot = await db.collection("participants").get();
                snapshot.forEach(doc => {
                    const d = doc.data();
                    data.push({
                        Nome: d.name,
                        Email: d.email || "N/A",
                        Telefone: d.phone,
                        Premio: d.prize,
                        Data: d.last_spin_date
                    });
                });
            }

            if(data.length === 0) { alert("Sem dados."); btn.innerText = "ðŸ“¥ Exportar Dados"; return; }

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Participantes");
            XLSX.writeFile(wb, "Infinix_Campanha.xlsx");
            btn.innerText = "ðŸ“¥ Exportar Dados (Excel)";
            
        } catch(e) {
            console.error(e);
            alert("Erro: PermissÃµes de Admin necessÃ¡rias no Firebase Console.");
            btn.innerText = "Erro ao Exportar";
        }
    }

    document.getElementById('btnSpin').addEventListener('click', () => {
        sfx.click();
        const btn = document.getElementById('btnSpin');
        btn.disabled = true; btn.innerText = "A GIRAR...";

        const r = Math.random() * 100;
        let label = "Tente de Novo";
        if(r < 0.1) label = "HOT 60 Pro+";
        else if(r < 5) label = "AcessÃ³rios";
        else if(r < 45) label = "Desconto Yango";

        const indices = [];
        sectors.forEach((s, i) => { if(s.label === label) indices.push(i); });
        const winnerIndex = indices[Math.floor(Math.random() * indices.length)];

        const sliceDeg = 360 / sectors.length;
        const winnerAngle = (winnerIndex * sliceDeg) + (sliceDeg / 2);
        let targetRotation = 270 - winnerAngle;
        while(targetRotation < 0) targetRotation += 360;
        
        const currentMod = currentRotation % 360;
        let dist = targetRotation - currentMod;
        if(dist < 0) dist += 360; 
        
        const finalRot = currentRotation + 1800 + dist; 

        let start = null;
        const dur = 5000;
        let lastTick = 0;

        function step(ts) {
            if(!start) start = ts;
            const progress = ts - start;
            const pct = Math.min(progress / dur, 1);
            const ease = 1 - Math.pow(1 - pct, 4); 
            
            const newAng = currentRotation + (finalRot - currentRotation) * ease;
            document.getElementById('wheel').style.transform = `rotate(${newAng}deg)`;

            if (newAng - lastTick > sliceDeg) { sfx.tick(); lastTick = newAng; }

            if(progress < dur) requestAnimationFrame(step);
            else {
                currentRotation = finalRot;
                finalizar(label);
            }
        }
        requestAnimationFrame(step);
    });

    function finalizar(premio) {
        if(!isAdmin) localStorage.setItem("spin_" + userData.phone, new Date().toISOString().split('T')[0]);
        
        const user = firebase.auth().currentUser;
        if(user && !isOffline) {
            db.collection("participants").doc(user.uid).set({
                name: userData.name, 
                email: userData.email, 
                phone: userData.phone,
                last_spin_date: new Date().toISOString().split('T')[0], prize: premio
            }, { merge: true });
        }

        if(premio === "Tente de Novo") {
            sfx.error(); showMsg("GAME OVER. Tenta amanhÃ£!", "error");
        } else {
            sfx.win(); showMsg("GANHASTE: " + premio + "!", "success");
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#00ff9d', '#ff0055', '#ffcc00'] });
        }

        const btn = document.getElementById('btnSpin');
        btn.innerText = isAdmin ? "RESET (ADMIN)" : "VOLTE AMANHÃƒ";
        if(isAdmin) btn.disabled = false;
    }

    function showMsg(txt, type) {
        const box = document.getElementById('msgBox');
        box.style.display = "block";
        box.innerText = txt;
        box.className = type;
    }
</script>

</body>
</html>