<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Infinix & Yango Arcade</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #130b21;
            --card-bg: #1e1333;
            --neon-pink: #ff0055;
            --neon-green: #00ff9d;
            --neon-blue: #00d9ff;
            --neon-yellow: #ffcc00;
            --text-white: #ffffff;
        }

        body { 
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 0, 85, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 255, 157, 0.15) 0%, transparent 40%);
            color: var(--text-white);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }

        .arcade-container {
            width: 100%; max-width: 380px;
            background: rgba(30, 19, 51, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 30px 20px;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.1), 0 20px 50px rgba(0,0,0,0.6);
            text-align: center;
            position: relative;
            display: flex; flex-direction: column;
            max-height: 95vh;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .lights-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .light-group { display: flex; gap: 8px; }
        .light { width: 8px; height: 8px; border-radius: 50%; background: #333; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .light.on-pink { background: var(--neon-pink); box-shadow: 0 0 10px var(--neon-pink); }
        .light.on-green { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
        .sound-toggle { font-size: 16px; cursor: pointer; opacity: 0.7; }

        h1 { margin: 0; font-size: 22px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        p { color: #aaa; font-size: 13px; margin-top: 5px; margin-bottom: 20px; }

        .game-input {
            width: 100%; padding: 15px;
            background: #130b21;
            border: 2px solid #2d1f45;
            border-radius: 12px;
            color: #fff; font-family: 'Outfit', sans-serif; font-size: 16px;
            text-align: center; outline: none; margin-bottom: 12px;
            box-sizing: border-box; transition: 0.3s;
        }
        .game-input:focus { border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(0, 217, 255, 0.3); }

        .btn-play {
            width: 100%; padding: 16px;
            background: linear-gradient(90deg, var(--neon-pink), #ff5e00);
            border: none; border-radius: 12px;
            color: white; font-weight: 800; font-size: 16px; text-transform: uppercase;
            cursor: pointer; margin-top: 10px;
            box-shadow: 0 5px 20px rgba(255, 0, 85, 0.4);
            position: relative; overflow: hidden;
            transition: transform 0.1s;
        }
        .btn-play:active { transform: scale(0.97); }
        .btn-play:disabled { filter: grayscale(1); cursor: not-allowed; }

        .btn-export {
            background: transparent; border: 1px solid var(--neon-green); color: var(--neon-green);
            padding: 8px 15px; border-radius: 8px; font-size: 12px; font-weight: 700;
            cursor: pointer; margin-top: 10px; display: none; width: 100%; text-transform: uppercase;
        }
        .btn-export:hover { background: rgba(0, 255, 157, 0.1); }

        /* STOCK PANEL */
        #stock-panel {
            margin-top: 15px; 
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
        }
        .stock-badge {
            background: rgba(0,0,0,0.3); border-radius: 8px; padding: 8px;
            font-size: 11px; text-align: left; border: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .stock-badge b { color: var(--neon-green); }
        .stock-warn b { color: var(--neon-pink); animation: pulse-text 1s infinite; }
        @keyframes pulse-text { 50% { opacity: 0.5; } }

        /* CONTADOR TENTATIVAS */
        #attempts-display {
            margin-top: 10px; background: rgba(255, 0, 85, 0.2); border: 1px solid var(--neon-pink);
            color: #fff; padding: 8px; border-radius: 8px; font-size: 12px; font-weight: bold;
            display: none;
        }

        .wheel-wrapper {
            position: relative; 
            width: 320px; height: 320px; 
            margin: 10px auto;
            display: flex; align-items: center; justify-content: center;
        }
        
        .wheel-background {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            background: #130b21; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 8px solid #2d1f45; box-sizing: border-box; z-index: 0;
        }

        canvas#wheel {
            position: relative; z-index: 1; 
            width: 100%; height: 100%; 
            border-radius: 50%; transform-origin: center center;
            will-change: transform; transform: translateZ(0); 
            backface-visibility: hidden; perspective: 1000px;
            -webkit-font-smoothing: antialiased;
        }

        .pointer {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            z-index: 10; width: 0; height: 0;
            border-left: 20px solid transparent; border-right: 20px solid transparent;
            border-top: 40px solid var(--neon-pink);
            filter: drop-shadow(0 4px 5px rgba(0,0,0,0.5));
        }

        .floating-icon { animation: float 3s ease-in-out infinite; display: inline-block; margin-bottom: 10px; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        #msgBox { margin-top: 15px; padding: 12px; border-radius: 8px; font-size: 13px; font-weight: 700; display: none; }
        .success { color: var(--neon-green); background: rgba(0, 255, 157, 0.1); border: 1px solid var(--neon-green); }
        .error { color: var(--neon-pink); background: rgba(255, 0, 85, 0.1); border: 1px solid var(--neon-pink); }

        .legal-footer { margin-top: 20px; font-size: 10px; color: #666; }
        .legal-footer a { color: #888; text-decoration: none; margin: 0 5px; }
        
        #terms-modal, #gps-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100; display: none;
            align-items: center; justify-content: center;
        }
        .terms-box { background: var(--card-bg); padding: 25px; border-radius: 20px; width: 85%; max-width: 300px; text-align: left; border: 1px solid #333; }
        .terms-box h3 { color: var(--neon-green); margin-top: 0; }
        .terms-box p { color: #ccc; font-size: 12px; }

        #step-wheel { display: none; }
        
        #access-denied { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-deep); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px; box-sizing: border-box; }
        #access-denied h2 { color: var(--neon-pink); font-size: 24px; margin-bottom: 10px; text-transform: uppercase; }
        #access-denied p { color: #ccc; font-size: 16px; line-height: 1.6; }
        .lock-icon { font-size: 60px; margin-bottom: 20px; }
        
        .badge { font-size: 9px; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; font-weight: 800; display: inline-block; margin-left: 5px; }
        .bg-admin { background: var(--neon-green); color: black; }
        .bg-car { background: var(--neon-blue); color: black; }
    </style>
</head>
<body>

<div id="access-denied">
    <div class="lock-icon">üîí</div>
    <h2>Acesso Exclusivo</h2>
    <p>Esta oferta √© exclusiva para passageiros Yango.</p>
    <p style="font-size:14px; margin-top:20px; color:var(--neon-blue)">Encontra um carro Yango e digitaliza o c√≥digo para participar!</p>
</div>

<!-- MODAL GPS -->
<div id="gps-modal" style="display:flex;">
    <div class="terms-box" style="text-align:center;">
        <div style="font-size:40px; margin-bottom:10px;">üìç</div>
        <h3>Confirma√ß√£o GPS</h3>
        <p>Precisamos validar que est√°s no carro para desbloquear o jogo.</p>
        <button onclick="requestGPS()" class="btn-play">ATIVAR LOCALIZA√á√ÉO</button>
    </div>
</div>

<!-- MODAL TERMOS -->
<div id="terms-modal">
    <div class="terms-box">
        <h3>Regras Oficiais</h3>
        <p>1. Apenas 1 jogada por n√∫mero, por dia.</p>
        <p>2. Os vencedores ser√£o contactados pela empresa.</p>
        <p>3. Fraudes resultam em banimento.</p>
        <button onclick="document.getElementById('terms-modal').style.display='none'" class="btn-play" style="margin-top:15px; padding:10px;">FECHAR</button>
    </div>
</div>

<div class="arcade-container" id="main-app" style="opacity:0.3; pointer-events:none;">
    <div class="lights-bar">
        <div class="light-group">
            <div class="light on-pink"></div>
            <div class="light"></div>
            <div class="light on-green"></div>
        </div>
        <div class="sound-toggle" onclick="toggleSound()" id="sound-btn">üîä</div>
    </div>

    <!-- TELA 1: DADOS -->
    <div id="step-login">
        <div class="floating-icon">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#00d9ff" stroke-width="1.5"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><path d="M12 6v6l4 2"/></svg>
        </div>
        <h1>Arcade Login</h1>
        
        <!-- Indicador do Carro -->
        <div id="car-id-display" style="margin-bottom:15px;">
            <span class="badge bg-car">Carro N√£o Detetado</span>
        </div>

        <input type="text" id="inputName" class="game-input" placeholder="Teu Nome">
        <input type="email" id="inputEmail" class="game-input" placeholder="Teu Email">
        
        <!-- CAMPO TELEFONE -->
        <input type="tel" id="inputPhone" class="game-input" placeholder="84 / 85 / 86 / 87 ...">
        
        <button onclick="enterGame()" id="btnSend" class="btn-play">ENTRAR & JOGAR</button>
    </div>

    <!-- TELA 2: RODA -->
    <div id="step-wheel">
        <h1>Spin & Win <span id="admin-badge" class="badge bg-admin" style="display:none">ADMIN</span></h1>
        
        <!-- STOCK P√öBLICO -->
        <div id="stock-panel">
            <div class="stock-badge" id="stock-hot60">üì± Hot 60: <b>...</b></div>
            <div class="stock-badge" id="stock-acessorios">üéß Acess√≥rios: <b>...</b></div>
            <div class="stock-badge" id="stock-yango20">üöï -20% Yango: <b>...</b></div>
            <div class="stock-badge" id="stock-yango10">üöï -10% Yango: <b>...</b></div>
        </div>
        
        <!-- CONTADOR -->
        <div id="attempts-display">Jogada 1 de 3</div>

        <div class="wheel-wrapper">
            <div class="wheel-background"></div>
            <div class="pointer"></div>
            <canvas id="wheel"></canvas>
        </div>

        <button id="btnSpin" class="btn-play">GIRAR (FREE)</button>
        <!-- BOT√ÉO EXPORTAR (ADMIN ONLY) -->
        <button id="btnExport" class="btn-export" onclick="exportData()">üì• Exportar Vencedores</button>
        
        <div class="legal-footer">
            <a href="#" onclick="document.getElementById('terms-modal').style.display='flex'">Termos</a>
        </div>
    </div>

    <div id="msgBox"></div>
</div>

<script>
    // --- 1. INTEGRA√á√ÉO GOOGLE SHEETS ---
    const SHEET_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbxdt--iC4oRJdde0SUahq17Pi5gdxWv6ctqv-7ricHgZC9IjjdZstXTPQ86CcWRu0IW/exec"

    // --- 2. SETUP CANVAS ---
    const canvas = document.querySelector("#wheel");
    const ctx = canvas.getContext("2d");
    const size = 320; 
    const dpr = window.devicePixelRatio || 1;
    canvas.width = size * dpr; canvas.height = size * dpr;
    canvas.style.width = `${size}px`; canvas.style.height = `${size}px`;
    ctx.scale(dpr, dpr);
    const dia = size; const rad = dia / 2;

    // --- 3. SEGURAN√áA DE ACESSO ---
    const ALLOWED_CARS = ['carro_01', 'carro_02', 'carro_03'];
    let currentCarId = null;

    function checkAccess() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id'); 
        
        if (id && ALLOWED_CARS.includes(id)) {
            currentCarId = id;
            document.querySelector('#car-id-display span').innerText = `üìç ${id.toUpperCase()}`;
            // Ativa app (GPS removido, ativa direto)
            document.getElementById('gps-modal').style.display = 'none';
            document.getElementById('main-app').style.opacity = '1';
            document.getElementById('main-app').style.pointerEvents = 'all';
            return true;
        }
        document.getElementById('gps-modal').style.display = 'none';
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('access-denied').style.display = 'flex';
        return false;
    }
    // Executa ao iniciar
    let hasValidLink = checkAccess();

    // GPS REMOVIDO - Fun√ß√£o dummy apenas para n√£o quebrar refer√™ncias
    function requestGPS() { console.log("GPS bypassed"); }

    // --- 4. AUDIO ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    let soundOn = true;
    function toggleSound() { soundOn = !soundOn; document.getElementById('sound-btn').innerText = soundOn ? 'üîä' : 'üîá'; }
    function playTone(freq, type, dur) {
        if (!soundOn) return;
        try {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + dur);
        } catch(e) {}
    }
    const sfx = {
        click: () => playTone(600, 'square', 0.1),
        tick: () => playTone(800, 'triangle', 0.05),
        win: () => { [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => playTone(f, 'sine', 0.4), i*150)); },
        error: () => playTone(150, 'sawtooth', 0.4)
    };

    // --- 5. FIREBASE CONFIG (COLE SUAS CHAVES AQUI) ---
  const firebaseConfig = {

  apiKey: "AIzaSyDbvibPXx9rc8nyA4CKQNE5xAPevw4PnrE",

  authDomain: "spin-the-wheel0.firebaseapp.com",

  projectId: "spin-the-wheel0",

  storageBucket: "spin-the-wheel0.firebasestorage.app",

  messagingSenderId: "490612802646",

  appId: "1:490612802646:web:043a7f993206f0d745a7f7",

  measurementId: "G-GSYX6N4BXB"

};
    const INITIAL_STOCK = { hot60: 20, accessories: 20, yango10: 100, yango20: 100 };
    const ADMIN_B64 = "KzI1ODg2NTQ3NjMzMw=="; 
    const MAX_SPINS = 3;

    const sectors = [
        { color: "#00d9ff", text: "YANGO 10%", label: "yango10", textCol: "#000" }, 
        { color: "#8a2be2", text: "ACESS√ìRIOS", label: "accessories", textCol: "#fff" },    
        { color: "#221638", text: "TENTE", label: "loss", textCol: "#aaa" }, 
        { color: "#ffcc00", text: "HOT 60", label: "hot60", textCol: "#000" },  
        { color: "#ff0055", text: "YANGO 20%", label: "yango20", textCol: "#fff" },  
        { color: "#00ff9d", text: "ACESS√ìRIOS", label: "accessories", textCol: "#000" }      
    ];

    const PI = Math.PI; const TAU = 2 * PI; const arc = TAU / sectors.length;
    let currentRotation = 0;

    function drawWheel() {
        ctx.clearRect(0, 0, size, size);
        sectors.forEach((sector, i) => {
            const angulo = arc * i;
            ctx.save(); ctx.beginPath();
            ctx.fillStyle = sector.color;
            ctx.moveTo(rad, rad); ctx.arc(rad, rad, rad, angulo, angulo + arc); ctx.lineTo(rad, rad); ctx.fill();
            ctx.strokeStyle = "#130b21"; ctx.lineWidth = 2; ctx.stroke();
            ctx.translate(rad, rad); ctx.rotate(angulo + arc / 2); ctx.textAlign = "right";
            ctx.fillStyle = sector.textCol; ctx.font = "bold 15px 'Outfit', sans-serif"; 
            ctx.fillText(sector.text, rad - 25, 5); ctx.restore();
        });
        ctx.beginPath(); ctx.arc(rad, rad, 35, 0, TAU); ctx.fillStyle = "#1e1333"; ctx.fill();
        ctx.strokeStyle = "#00d9ff"; ctx.lineWidth = 3; ctx.stroke();
    }
    drawWheel();

    let isOffline = false; let isAdmin = false; let userData = {};
    let db;
    let dailySpinsCount = 0;

    try { 
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        firebase.auth().signInAnonymously().catch(e => console.warn("Auth anonima"));
    } catch(e) { isOffline=true; }

    window.onload = () => {
        document.body.addEventListener('click', () => { if(audioCtx.state === 'suspended') audioCtx.resume(); }, {once:true});
    };

    async function enterGame() {
        sfx.click();
        document.getElementById('msgBox').style.display = 'none';
        
        const name = document.getElementById('inputName').value;
        const email = document.getElementById('inputEmail').value;
        let rawPhone = document.getElementById('inputPhone').value.trim();
        
        if(!name || !email || !rawPhone) return showMsg("Preencha todos os dados", "error");

        let cleanDigits = rawPhone.replace(/\D/g, ''); 
        if (cleanDigits.startsWith('258') && cleanDigits.length > 9) cleanDigits = cleanDigits.substring(3);
        if (cleanDigits.length !== 9) return showMsg("O n√∫mero deve ter 9 d√≠gitos", "error");
        const validPrefixes = ['84', '85', '86', '87'];
        if (!validPrefixes.some(prefix => cleanDigits.startsWith(prefix))) return showMsg("Prefixo inv√°lido (84, 85, 86, 87)", "error");

        const finalPhone = "+258" + cleanDigits;
        
        userData = { name, email, phone: finalPhone, car_id: currentCarId || 'admin_bypass' };
        
        if(btoa(finalPhone) === ADMIN_B64) {
            isAdmin = true;
            document.getElementById('admin-badge').style.display = 'inline-block';
            document.getElementById('btnExport').style.display = 'block';
            document.getElementById('main-app').style.display = 'flex';
            document.getElementById('access-denied').style.display = 'none';
            updateStockDisplay();
            goToWheel();
            return;
        }

        if(!hasValidLink) { alert("Link inv√°lido. Usa o QR Code do carro."); return; }

        const btn = document.getElementById('btnSend');
        btn.disabled = true; btn.innerText = "A entrar...";

        const today = new Date().toISOString().split('T')[0];
        
        if(localStorage.getItem("spin_" + finalPhone) === today) {
            btn.disabled = false; btn.innerText = "ENTRAR";
            return showMsg("J√° jogaste hoje! Tenta amanh√£.", "error");
        }

        try {
            const docRef = db.collection("participants").doc(finalPhone);
            const docSnap = await docRef.get();
            if (docSnap.exists) {
                const data = docSnap.data();
                if (data.last_spin_date === today) {
                    if (data.daily_spins >= MAX_SPINS) {
                        btn.disabled = false; btn.innerText = "ENTRAR";
                        return showMsg("J√° usaste as 3 jogadas de hoje!", "error");
                    } else {
                        dailySpinsCount = data.daily_spins || 0;
                    }
                } else { dailySpinsCount = 0; }
            } else { dailySpinsCount = 0; }
            
            updateStockDisplay(); 
            goToWheel();
        } catch (e) {
            console.error("Firestore Error (Bypassing):", e);
            // Em caso de erro, deixa entrar (Fail-safe)
            dailySpinsCount = 0;
            updateStockDisplay(); 
            goToWheel();
        }
    }

    function goToWheel() {
        document.getElementById('step-login').style.display = 'none';
        document.getElementById('step-wheel').style.display = 'block';
        document.getElementById('lblName').innerText = userData.name.split(" ")[0];
        document.getElementById('msgBox').style.display = 'none';
        
        // Atualizar texto de tentativas
        const attemptsLeft = MAX_SPINS - dailySpinsCount;
        document.getElementById('attempts-display').style.display = 'block';
        document.getElementById('attempts-display').innerText = `Jogada ${dailySpinsCount + 1} de ${MAX_SPINS}`;
    }

    async function updateStockDisplay() {
        try {
            if (!db) { updateBadgesFromStock(INITIAL_STOCK); return; }
            const stockDoc = await db.collection("config").doc("inventory").get();
            let s = INITIAL_STOCK;
            if (stockDoc.exists) { s = stockDoc.data(); }
            updateBadgesFromStock(s);
        } catch(e) { 
            updateBadgesFromStock(INITIAL_STOCK);
        }
    }

    function updateBadgesFromStock(s) {
        updateBadge('stock-hot60', s.hot60);
        updateBadge('stock-acessorios', s.accessories);
        updateBadge('stock-yango20', s.yango20);
        updateBadge('stock-yango10', s.yango10);
    }

    function updateBadge(id, qtd) {
        const el = document.getElementById(id);
        const name = el.innerText.split(':')[0];
        el.innerHTML = `${name}: <b>${qtd !== undefined ? qtd : '?'}</b>`;
        if (qtd < 5) el.classList.add('stock-warn');
        else el.classList.remove('stock-warn');
    }

    document.getElementById('btnSpin').addEventListener('click', async () => {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        sfx.click();
        const btn = document.getElementById('btnSpin');
        btn.disabled = true; btn.innerText = "A GIRAR...";

        let stock = { ...INITIAL_STOCK };
        let stockDocRef = null;

        if (!isOffline && db) {
            try {
                stockDocRef = db.collection("config").doc("inventory");
                const stockSnap = await stockDocRef.get();
                if (stockSnap.exists) { stock = stockSnap.data(); }
                else { await stockDocRef.set(INITIAL_STOCK); }
            } catch(e) {}
        }

        const r = Math.random() * 100;
        let prizeKey = "loss"; 
        let labelDisplay = "Tente de Novo";

        if (r < 0.1 && stock.hot60 > 0) { prizeKey = "hot60"; labelDisplay = "Infinix HOT 60 Pro+"; } 
        else if (r < 5 && stock.accessories > 0) { prizeKey = "accessories"; labelDisplay = "Acess√≥rios Infinix"; } 
        else if (r < 25 && stock.yango20 > 0) { prizeKey = "yango20"; labelDisplay = "Desconto Yango 20%"; } 
        else if (r < 45 && stock.yango10 > 0) { prizeKey = "yango10"; labelDisplay = "Desconto Yango 10%"; } 
        else { prizeKey = "loss"; labelDisplay = "Tente de Novo"; }

        const indices = [];
        sectors.forEach((s, i) => { if(s.label === prizeKey || (prizeKey === 'loss' && s.label === 'loss')) indices.push(i); });
        if(indices.length === 0) {
             sectors.forEach((s, i) => { if(s.label === 'loss') indices.push(i); });
             prizeKey = 'loss'; labelDisplay = "Tente de Novo";
        }
        
        const winnerIndex = indices[Math.floor(Math.random() * indices.length)];
        const sliceDeg = 360 / sectors.length;
        const winnerAngle = (winnerIndex * sliceDeg) + (sliceDeg / 2);
        let targetRotation = 270 - winnerAngle;
        while(targetRotation < 0) targetRotation += 360;
        
        const currentMod = currentRotation % 360;
        let dist = targetRotation - currentMod;
        if(dist < 0) dist += 360; 
        const finalRot = currentRotation + 1800 + dist; 

        let start = null; const dur = 5000;
        function step(ts) {
            if(!start) start = ts;
            const progress = ts - start;
            const pct = Math.min(progress / dur, 1);
            const ease = 1 - Math.pow(1 - pct, 4); 
            const newAng = currentRotation + (finalRot - currentRotation) * ease;
            document.getElementById('wheel').style.transform = `rotate(${newAng}deg)`;
            const now = Date.now();
            if (pct < 0.8 && Math.random() > 0.85) sfx.tick(); 
            if(progress < dur) requestAnimationFrame(step);
            else {
                currentRotation = finalRot;
                processWin(prizeKey, labelDisplay, stockDocRef);
            }
        }
        requestAnimationFrame(step);
    });

    async function processWin(prizeKey, labelDisplay, stockDocRef) {
        const phoneToSave = userData.phone; 
        const today = new Date().toISOString().split('T')[0];

        // Decrement Stock (S√≥ se ganhou e n√£o for admin)
        if (prizeKey !== "loss" && !isAdmin && !isOffline && stockDocRef) {
            try {
                await stockDocRef.update({ [prizeKey]: firebase.firestore.FieldValue.increment(-1) });
                updateStockDisplay();
            } catch(e) {}
        }

        // Atualizar contador local
        dailySpinsCount++;
        const attemptsLeft = MAX_SPINS - dailySpinsCount;

        if(!isAdmin) localStorage.setItem("spin_" + phoneToSave, today);
        
        if(!isOffline) {
            try {
                // 1. ATUALIZAR PARTICIPANTE (Contagem de spins)
                const participantData = {
                    name: userData.name, email: userData.email, phone: phoneToSave,
                    car_id: userData.car_id, 
                    last_spin_date: today, 
                    daily_spins: dailySpinsCount,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection("participants").doc(phoneToSave).set(participantData, { merge: true });
                
                // 2. REGISTAR VENCEDOR NA COLE√á√ÉO "WINNERS" (Apenas se ganhou)
                if(prizeKey !== "loss") {
                    const winnerData = {
                        ...participantData,
                        prize: labelDisplay,
                        win_date: new Date()
                    };
                    
                    await db.collection("winners").add(winnerData);
                    
                    // Webhook para Sheets
                    if(SHEET_WEBHOOK_URL) {
                       fetch(SHEET_WEBHOOK_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(winnerData) });
                    }
                }

            } catch(e) { console.error("Erro ao gravar", e); }
        }

        if(prizeKey === "loss") {
            sfx.error(); showMsg("GAME OVER. Tenta de novo!", "error");
        } else {
            sfx.win(); showMsg("GANHASTE: " + labelDisplay + "!", "success");
            confetti({ particleCount: 100, spread: 60, origin: { y: 0.6 }, colors: ['#00ff9d', '#ff0055', '#ffcc00'] });
        }

        const btn = document.getElementById('btnSpin');
        if (attemptsLeft > 0) {
            btn.innerText = `GIRAR (${attemptsLeft} RESTANTES)`;
            btn.disabled = false;
            document.getElementById('attempts-display').innerText = `Jogada ${dailySpinsCount + 1} de ${MAX_SPINS}`;
        } else {
            btn.innerText = "VOLTA AMANH√É";
            btn.disabled = true;
            document.getElementById('attempts-display').innerText = "0 Jogadas Restantes";
        }

        if(isAdmin) {
            document.getElementById('btnSpin').style.display = 'block';
            document.getElementById('btnSpin').innerText = "RESET (ADMIN)";
            document.getElementById('btnSpin').disabled = false;
        }
    }

    // Fun√ß√£o de exporta√ß√£o: L√™ da tabela "WINNERS"
    async function exportData() {
        if(!isAdmin) return;
        const btn = document.getElementById('btnExport');
        btn.innerText = "A Gerar Excel...";
        
        try {
            let data = [];
            // Agora lemos a cole√ß√£o correta: WINNERS
            const snapshot = await db.collection("winners").get();
            snapshot.forEach(doc => {
                const d = doc.data();
                data.push({
                    Nome: d.name,
                    CarroID: d.car_id, 
                    Email: d.email, Telefone: d.phone, 
                    Premio: d.prize, Data: d.last_spin_date
                });
            });

            if(data.length === 0) { alert("Sem vencedores."); btn.innerText = "üì• Exportar"; return; }

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Vencedores");
            XLSX.writeFile(wb, "Vencedores_Infinix.xlsx");
            btn.innerText = "üì• Exportar Vencedores";
            
        } catch(e) {
            console.error(e);
            alert("Erro ao exportar.");
            btn.innerText = "Erro";
        }
    }

    function showMsg(txt, type) {
        const box = document.getElementById('msgBox');
        box.style.display = "block";
        box.innerText = txt;
        box.className = type;
    }
</script>

</body>
</html>
